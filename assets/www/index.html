<!DOCTYPE html> 
<html> 
    <head> 
    <title>Karetni hra Prsi</title> 
    <link rel="stylesheet" type="text/css" href="main.css">
    <!--  link rel="stylesheet" type="text/css" href="colors.css" -->
    <script type="text/javascript" charset="utf-8" src="phonegap.js"></script>
    <script type="text/javascript" charset="utf-8" src="jquery.js"></script>
    <script type="text/javascript" charset="utf-8" src="lang.js"></script>
    <script type="text/javascript">
      $(document).ready(function() {
          loadColors();
          $('div#zacni_hru').click(clickZacniHru);
          $('div#jdi_na_tah').click(clickJdiNaTah);
          $('div#tah_hotovy').click(clickTahHotovy);
          $('div#nova_hra').click(clickNovaHra);
          $('div.dalsibarva').click(clickDalsiBarva);
          $('input.hraci_jmena').change(changeHraciJmena);
          $('div.view').css('display', 'none');
          $('div.panel').height(300);
          initHraci();
          $('.translate').map(function() {
              $(this).text(t($(this).text()));
          });
      });
      function loadColors() {
          var link = $('<link>');
          link.attr({
              type: 'text/css',
              rel: 'stylesheet',
              href: 'colors.css'
          });
          $('head').append(link);
      }
      function t(txt) {
        var text = texts[txt];
        if (!text) alert(txt);
        var formatted = text.cz;
        for(arg in arguments) {
          if (arg > 0) formatted = formatted.replace("{" + arg + "}", arguments[arg]);
        }
        return formatted;        
      }
      function initHraci() {
          $('div#hraci').css('display', '');
          changeHraciJmena(null);
      };
      function enabledZacniHru() {
      	  var vyplneniHraci = $('input.hraci_jmena').filter(
      	  	  function(index) { return this.value; }
      	  	  );
      	  return (vyplneniHraci.length >= 2);
      }
      function changeHraciJmena(event) {
      	  if (enabledZacniHru()) 
            $('div#zacni_hru').removeClass('disabled')
          else
            $('div#zacni_hru').addClass('disabled');
      };
      var hra = {};
      var hodnoty = ['7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
      var barvy = ['srdce', 'kary', 'zelena', 'zaludy'];
      function clickZacniHru(event) {
          if (!enabledZacniHru()) {
            alert(t('at_least_2_players_needed'));
          }
          else {
              $('div#hraci').css('display', 'none');
              pripravHru();
              displayPredavka();
          };
      };
      function displayPredavka() {
          $('div#hrac_predavka').text(hra.hraci[0].name);
          $('div#predavka').css('display', '');
      };
      function pripravHru() {
         hra = { hraci: [], karty: [], nastole: [], lizani: 0, cekani: false, historie: [] };
         $('input.hraci_jmena').map(function(index, el) {
         		 if (el.value) {
          		 	 hra.hraci.push({ 
          		 	   name: el.value, 
          		 	   vruce: [] 
          		 	 });
         		 };
         });
         var kr_index = 0;
         var karty = [];
         for(var hd_ix in hodnoty) {
           for(var br_ix in barvy) {
             karty[kr_index++] = { 
               id: barvy[br_ix]+'-'+hodnoty[hd_ix],
               barva: br_ix, hodnota: hd_ix
             };
           }
         };
         // zamichat karty
         while (karty.length > 0) {
           var rnd_ix = Math.floor(Math.random()*karty.length)
           hra.karty.push(karty.splice(rnd_ix, 1)[0]);
         };
         kr_trideni = 0;
         for(var ix in [1,2,3,4]) {
           for(var hr_ix in hra.hraci) {
             var hrac = hra.hraci[hr_ix];
             hrac.vruce.push(kr_trideni++);
           }
         };
         while(kr_trideni<hra.karty.length) {
           hra.nastole.push(kr_trideni++);
         };
         hra.dalsi_barva = hra.karty[hra.nastole[0]].barva;
         hra.lizani = (hodnoty[hra.karty[hra.nastole[0]].hodnota] == '7') ? 2 : 0;
         hra.cekani = (hodnoty[hra.karty[hra.nastole[0]].hodnota] == 'A');
      };
      function pridejKartu(el, kr_ix, btn, shadow) {
        if (typeof(kr_ix) == 'number') {
          var karta = hra.karty[kr_ix];
          var barva = barvy[karta.barva] 
          var kr_html = '<div class="karta '
                      + barva 
                      + ((shadow) ? ' shadow' : '')
                      + '">'
                      + hodnoty[karta.hodnota]
                      + '</div>';
          var dt_karta = kr_ix; 
        }
        else {
          var kr_html = '<div class="rub-karta'
                      + ((shadow) ? ' shadow' : '')
                      + '">'+kr_ix+'</div>';
          var dt_karta = -btn;
        }
        var html = '<div data-karta="'+dt_karta+'" class="karta_box'
                 + (btn > 0 ? ' klikaci': '') 
                 + ((shadow) ? ' mazaci' : '')
                 + '">';
        html += kr_html;
        html += (btn > 0)
              ? '<div id="button-podkartou-'+kr_ix+'" class="podkartou">.</div>'
              : '<div class="podstavec">.</div>';
        html += '</div>';
        el.append(html);
      }
      function vezmiKartu() {
        if ($(this).hasClass('vyrazna')) {
          $('div.mazaci')
            .removeClass('vyrazna')
            .removeClass('maznuta');
          hra.volba = null;
          if (!hra.cekani) $('div#tah_hotovy').addClass('disabled');
          $('div#section_dalsibarva').addClass('hidden');
        }
        else {
          $('div.mazaci')
            .removeClass('vyrazna')
            .addClass('maznuta');
          $(this)
            .removeClass('maznuta')
            .addClass('vyrazna');
          hra.volba = parseInt(this.attributes['data-karta'].value);
          if (hra.volba >= 0 && hodnoty[hra.karty[hra.volba].hodnota] == 'Q') { 
            $('div#tah_hotovy').addClass('disabled');
            $('div.dalsibarva').removeClass('maznuta');
            $('div#section_dalsibarva').removeClass('hidden');
          }
          else {
            $('div#tah_hotovy').removeClass('disabled');
            $('div#section_dalsibarva').addClass('hidden');
          }
        };
      };
      function clickDalsiBarva() {
        $('div.dalsibarva').addClass('maznuta');
        $(this).removeClass('maznuta');
        hra.dalsi_barva = parseInt(this.attributes['data-barva'].value);
        $('div#tah_hotovy').removeClass('disabled');
      }
      function povolenaKarta(karta) {
        var karta_barva = hra.karty[karta].barva;
        var nastole_barva = hra.dalsi_barva;
        var karta_hodnota = hra.karty[karta].hodnota;
        var nastole_hodnota = hra.karty[hra.nastole[0]].hodnota;
             
        var povoleno = false;
        if (hra.lizani > 0 && hodnoty[nastole_hodnota] == '7') {
          povoleno = (karta_hodnota == nastole_hodnota)
        }
        else 
        if (hra.cekani && hodnoty[nastole_hodnota] == 'A') {
          povoleno = (karta_hodnota == nastole_hodnota)
        }
        else {
          povoleno = ( 
                       hodnoty[karta_hodnota] == 'Q'     // svrsek muze vzdycky 
                   ||  karta_barva == nastole_barva || karta_hodnota == nastole_hodnota
          );
        };
        return (povoleno? 1 : 0);
      }
      function povoleneLizani(karta) {
        var nastole_hodnota = hra.karty[hra.nastole[0]].hodnota;
             
        var povoleno = 1;
        if (hra.lizani > 0 && hodnoty[nastole_hodnota] == '7') {
          povoleno = hra.lizani;
        }
        else if (hra.cekani && hodnoty[nastole_hodnota] == 'A') {
          povoleno = 0;
        };
        return povoleno;
      }
      function pocetKaretText(karet) {
        return t(
          ((karet == 1) ? '1_card' : 
          ((karet <= 4) ? '2_4_cards{1}' :
                         'more_cards{1}')),
        karet);
      }
      function displayStolek() {
         $('div#predavka').css('display', 'none');
         
         $('div#section_hrac').empty().append('<div class="hrac_na_tahu">' + t('player_on_move({1})', hra.hraci[0].name) + '</div>');
         
         var vruce = $('div#vruce');
         vruce.empty();
         for(var kr_ix in hra.hraci[0].vruce) {
           var karta = hra.hraci[0].vruce[kr_ix];
           pridejKartu(vruce, karta, povolenaKarta(karta), true);
         };
         
         var nastole = $('div#nastole');
         nastole.empty();
         pridejKartu(nastole, hra.nastole[0], false, true);
         pridejKartu(nastole, pocetKaretText(hra.nastole.length-1), false, true);
         
         var lizani = povoleneLizani(karta);
         if (lizani > 0) pridejKartu(nastole, t('take_cards({1})', lizani), lizani, true);
         
         $('div.klikaci').click(vezmiKartu);
         
         $('div#section_dalsibarva').addClass('hidden');
            
         var historie = $('div#historie');
         historie.empty();
         
         var zadna_historie = true;
         for(var hr_ix in hra.hraci) {
           if (hr_ix > 0) {
             if (hra.hraci[hr_ix].tah) {
               zadna_historie = false;
               historie.append('<div id="hrac-historie-'+hr_ix+'" class="hrac_historie"></div>');
               var hr_hist = $('div#hrac-historie-'+hr_ix);
               hr_hist.append('<div class="hrac_jmeno">' + hra.hraci[hr_ix].name + '</name>'); 
               pridejKartu(hr_hist, pocetKaretText(hra.hraci[hr_ix].vruce.length), false, false);
               if (hra.hraci[hr_ix].tah.karta >= 0) {
                 pridejKartu(hr_hist, hra.hraci[hr_ix].tah.karta, false, false);
                 if (hodnoty[hra.karty[hra.hraci[hr_ix].tah.karta].hodnota]=='Q') {
                   hr_hist.append(
                        '<div class="hrac_novabarva"><img src="' + barvy[hra.hraci[hr_ix].tah.barva] + '30.png"/></div>');
                 }
               }
               else 
               if (hra.hraci[hr_ix].tah.lizal > 0) {
                 hr_hist.append('<div class="hrac_zprava">' + t('taken_cards:{1}', hra.hraci[hr_ix].tah.lizal) + '</div>');
               }
               else {
                 hr_hist.append('<div class="hrac_zprava">' + t('skipped_due_a') + '</div>');
               }
             };
           }
         };
         if (zadna_historie) {
           historie.append('<div id="hrac-historie-none" class="hrac_historie">' + t('no_moves_yet') + '</div>');
         };
         
         hra.volba = null;
         if (!hra.cekani) $('div#tah_hotovy').addClass('disabled');
         
         $('div#stolek').css('display', '');
      }
      function zapisHistorii(lizal, karta, barva) {
        hra.hraci[0].tah = {'lizal': lizal, 'karta': karta, 'barva': barva};
        hra.historie.unshift({'hrac': hra.hraci[0].name, 'lizal': lizal, 'karta': karta, 'barva': barva});
      }
      function dalsiTah() {
        if (hra.volba==null) {
          zapisHistorii(0, -1, -1);
        }
        else {
          if (hra.volba < 0) { // liznout ze stolu
            var karty = -hra.volba;
            zapisHistorii(karty, -1, -1);
            while (karty > 0) {
              hra.hraci[0].vruce.push(hra.nastole.pop());
              karty--;
            };
            hra.lizani = 0;
          }
          else {               // vyhodit zvolenou kartu
            var idx = hra.hraci[0].vruce.indexOf(hra.volba);
            if (idx != -1) { 
              hra.hraci[0].vruce.splice(idx, 1);
              hra.nastole.unshift(hra.volba);
              if (hodnoty[hra.karty[hra.volba].hodnota]=='7') {
                hra.lizani += 2;
              };
              if (hodnoty[hra.karty[hra.volba].hodnota]=='A') {
                hra.cekani = true;
              };
              if (hodnoty[hra.karty[hra.volba].hodnota]=='Q') {
                // svrsek urcil barvu uz driv...
              }
              else {
                hra.dalsi_barva = hra.karty[hra.nastole[0]].barva;
              };
              zapisHistorii(0, hra.volba, hra.dalsi_barva);
            };
          };
        };
      }
      function clickJdiNaTah() {
        displayStolek();
       };
      function displayVitez() {
        $('div#hrac_vitez').text(hra.hraci[0].name);
        $('div#vitez').css('display', '');
      };
      function clickNovaHra () {
        $('div#vitez').css('display', 'none');
        initHraci();
      };
      function clickTahHotovy() {
        if (hra.volba==null) {
          if (hra.cekani) {
            hra.cekani = false; // cekame na esu, nedelame nic...
          }
          else {
            alert(t('decide_on_move_first'));
            return;
          };
        };
        $('div#stolek').css('display', 'none');
        dalsiTah();
        if (hra.hraci[0].vruce.length==0) {
          displayVitez();
        }
        else {
          dalsiHrac();
          displayPredavka();
        };
      };
      function dalsiHrac() {
        hra.hraci.push(hra.hraci.shift());
      };
    </script>
</head> 
<body> 
  <div id="header" class="header">
    <h1>
      <span id="h1_first" class="translate">game_header1</span>
      <span id="h1_second" class="translate">game_header2</span>
    </h1>
  </div>
  <div id="hraci" class="view">
    <div class="napoveda translate">player_intro</div>
    <div class="input_row">
      <div class="label"><label class="translate" for="name-hrace-1">player_1st</label></div>
      <div class="input"><input type="text" class="hraci_jmena" name="hrac-1" id="name-hrace-1"></div>
    </div>
    <div class="input_row">
      <div class="label"><label class="translate" for="name-hrace-2">player_2nd</label></div>
      <div class="input"><input type="text" class="hraci_jmena" name="hrac-2" id="name-hrace-2"></div>
    </div>
    <div class="input_row">
      <div class="label"><label class="translate" for="name-hrace-3">player_3rd</label></div>
      <div class="input"><input type="text" class="hraci_jmena" name="hrac-3" id="name-hrace-3"></div>
    </div>
    <div class="input_row">
      <div class="label"><label class="translate" for="name-hrace-4">player_4th</label></div>
      <div class="input"><input type="text" class="hraci_jmena" name="hrac-4" id="name-hrace-4"></div>
    </div>
    <div class="input_row">
      <div class="label"><label class="translate" for="name-hrace-5">player_5th</label></div>
      <div class="input"><input type="text" class="hraci_jmena" name="hrac-5" id="name-hrace-5"></div>
    </div>
    <div id="zacni_hru" class="button translate">start_game_button</div>
  </div>
  <div id="stolek" class="view">
    <div class="section" id="section_hrac"></div>
    <div class="section" id="section_nastole">
      <div class="title translate">title_cards_on_desk</div>
      <div id="nastole"></div>
    </div>
    <div class="section hidden" id="section_dalsibarva">
      <div class="title translate">title_select_next_color</div>
      <div id="dalsibarva">
        <div data-barva="0" class="dalsibarva shadow"><img src="srdce68.png"></div>
        <div data-barva="1" class="dalsibarva shadow"><img src="kary68.png"></div>
        <div data-barva="2" class="dalsibarva shadow"><img src="zelena68.png"></div>
        <div data-barva="3" class="dalsibarva shadow"><img src="zaludy68.png"></div>
      </div>
    </div>
    <div class="section" id="section_vruce">
      <div class="title translate">title_cards_in_hand</div>
      <div id="vruce"></div>
    </div>
    <div class="button translate" id="tah_hotovy">ready_next_button</div>
    <div class="section" id="section_historie">
      <div class="title translate">title_other_players</div>
      <div id="historie"></div>
    </div>
  </div>
  <div id="predavka" class="view">
    <div class="panel">
      <span class="translate">next_player_is</span>
      <div id="hrac_predavka"></div>
      <span class="translate">when_ready_click_button</span>
      <div class="button translate" id="jdi_na_tah">ready_for_game_button</div>
    </div>
  </div>
  <div id="vitez" class="view">
    <div class="panel">
      <span id="title_vitez" class="translate">and_winner_is</span>
      <div id="hrac_vitez"></div>
      <span class="translate">celebrate_hint</span>
      <div class="button translate" id="nova_hra">new_game_button</div>
    </div>
  </div>
</body>
</html>