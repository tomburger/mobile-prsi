<!DOCTYPE html> 
<html> 
    <head> 
    <title>Karetní hra Prší</title> 
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" type="text/css" href="main.css">
    <script type="text/javascript" charset="utf-8" src="phonegap.js"></script>
    <script type="text/javascript" charset="utf-8" src="jquery.js"></script>
    <script type="text/javascript" charset="utf-8" src="lang.js"></script>
    <script type="text/javascript" charset="utf-8" src="game.js"></script>
    <script type="text/javascript">
      $(document).ready(function() {
          parseQueryString();
          loadColors();
          $('.translate').map(function() {
              $(this).text(t($(this).text()));
          });
          $('div#zacni_hru').click(clickZacniHru);
          $('div#pridej_hrace').click(clickPridejHrace);
          $('div#jdi_na_tah').click(clickJdiNaTah);
          $('div#tah_hotovy').click(clickTahHotovy);
          $('div#nova_hra').click(clickNovaHra);
          $('div.dalsibarva').click(clickDalsiBarva);
          $('input.hraci_jmena').keypress(changeHraciJmena);
          $('div.view').css('display', 'none');
          $('div.panel').height(300);
          initHraci();
      });
      function parseQueryString() {
          var qs = window.location.search.substring(1);
          var parts = qs.split("&");
          window.prsi_color_scheme = parts[0];
          window.prsi_language = parts[1];
      }
      function loadColors() {
          var link = $('<link>');
          link.attr({
              type: 'text/css',
              rel: 'stylesheet',
              href: 'colors_' + window.prsi_color_scheme + '.css'
          });
          $('head').append(link);
      }
      function t(txt) {
        var text = texts[txt];
        if (!text) alert(txt);
        var formatted = text[window.prsi_language];
        for(arg in arguments) {
          if (arg > 0) formatted = formatted.replace("{" + arg + "}", arguments[arg]);
        }
        return formatted;        
      }
      
      function initHraci() {
          $('div#hraci').css('display', '');
          changeHraciJmena(null);
      }
      function enabledZacniHru() {
      	  var vyplneniHraci = $('input.hraci_jmena').filter(
      	  	  function(index) { return this.value; }
      	  	  );
      	  return (vyplneniHraci.length >= 2);
      }
      function clickPridejHrace() {
        $('div.input_row.hidden:first').map(function() {
            $(this).removeClass('hidden');
        });
        if ($('div.input_row.hidden').length == 0)
          $('div#pridej_hrace').addClass('disabled');
      }
      function changeHraciJmena(event) {
      	  if (enabledZacniHru()) 
            $('div#zacni_hru').removeClass('disabled')
          else
            $('div#zacni_hru').addClass('disabled');
      };
      function clickZacniHru(event) {
          if (!enabledZacniHru()) {
            alert(t('at_least_2_players_needed'));
          }
          else {
              $('div#hraci').css('display', 'none');
              pripravHru();
              displayPredavka();
          };
      };
      function displayPredavka() {
          $('div#hrac_predavka').text(hra.actualPlayer().name);
          $('div#predavka').css('display', '');
      };
      function pripravHru() {
      	 hra.init();
         $('input.hraci_jmena').map(function(index, el) {
         		 if (el.value) {
          		 	 hra.add_player({ 
          		 	   name: el.value, 
          		 	   vruce: [] 
          		 	 });
         		 };
         });
         hra.mix_cards();
         hra.give_cards();
      };
      function setChoice(choice) {
        $('input#stolek_volba').map(function(ix, el) { el.value=choice; });
      }
      function getChoice() {
        var choice = '';
        $('input#stolek_volba').map(function(ix, el) { choice = el.value; });
        return choice;
      }
      function clearChoice() {
        setChoice('');
        if (!hra.cekani) $('div#tah_hotovy').addClass('disabled');
      }
      function setColor(color) {
        $('input#stolek_barva').map(function(ix, el) { el.value=color; });
      }
      function getColor() {
        var color = '';
        $('input#stolek_barva').map(function(ix, el) { color = el.value; });
        return color;
      }
      function vezmiKartu() {
        if ($(this).hasClass('vyrazna')) {
          $('div.mazaci')
            .removeClass('vyrazna')
            .removeClass('maznuta');
          clearChoice();
          $('div#section_dalsibarva').addClass('hidden');
        }
        else {
          $('div.mazaci')
            .removeClass('vyrazna')
            .addClass('maznuta');
          $(this)
            .removeClass('maznuta')
            .addClass('vyrazna');
          var choice = parseInt(this.attributes['data-karta'].value); 
          setChoice(choice);
          if (choice >= 0 && hra.isColorCard(choice)) { 
            $('div#tah_hotovy').addClass('disabled');
            $('div.dalsibarva').removeClass('maznuta');
            $('div#section_dalsibarva').removeClass('hidden');
          }
          else {
            $('div#tah_hotovy').removeClass('disabled');
            $('div#section_dalsibarva').addClass('hidden');
          }
        };
      };
      function clickDalsiBarva() {
        $('div.dalsibarva').addClass('maznuta');
        $(this).removeClass('maznuta');
        setColor(this.attributes['data-barva'].value);
        $('div#tah_hotovy').removeClass('disabled');
      }
      function pridejKartu(el, kr_ix, br_ix, btn, shadow) {
        if (typeof(kr_ix) == 'number') {
          var karta = hra.karty[kr_ix];
          var barva = barvy[karta.barva] 
          var kr_html = '<div class="karta '
                      + barva 
                      + ((shadow) ? ' shadow' : '')
                      + '">'
                      + hodnoty[karta.hodnota]
                      + '</div>';
          var dt_karta = kr_ix; 
        }
        else {
          var kr_html = '<div class="rub-karta'
                      + ((shadow) ? ' shadow' : '')
                      + '">'+kr_ix+'</div>';
          var dt_karta = -btn;
        }
        var html = '<div data-karta="'+dt_karta+'" class="karta_box'
                 + (btn > 0 ? ' klikaci': '') 
                 + ((shadow) ? ' mazaci' : '')
                 + '">';
        html += kr_html;
        html += (btn > 0)
              ? '<div id="button-podkartou-'+kr_ix+'" class="podkartou">.</div>'
              : '<div class="podstavec">.</div>';
        if (br_ix >= 0)
          html += '<div class="karta_novabarva"><img src="' + barvy[br_ix] + '30.png"/></div>';
        html += '</div>';
        
        el.append(html);
      }
      function pocetKaretText(karet) {
        return t(
          ((karet == 1) ? '1_card' : 
          ((karet <= 4) ? '2_4_cards{1}' :
                         'more_cards{1}')),
        karet);
      }
      function displayStolek() {
         $('div#predavka').css('display', 'none');
         
         $('div#section_hrac').empty().append('<div class="hrac_na_tahu">' + t('player_on_move({1})', hra.actualPlayer().name) + '</div>');
         
         var vruce = $('div#vruce');
         vruce.empty();
         for(var kr_ix in hra.actualPlayer().vruce) {
           var karta = hra.actualPlayer().vruce[kr_ix];
           pridejKartu(vruce, karta, -1, hra.povolenaKarta(karta), true);
         };
         
         var nastole = $('div#nastole');
         nastole.empty();
         if (hra.isColorCard(hra.nastole[0])) {
           pridejKartu(nastole, hra.nastole[0], hra.dalsi_barva, false, true);
         }
         else {
           pridejKartu(nastole, hra.nastole[0], -1, false, true);
         };
        
         pridejKartu(nastole, pocetKaretText(hra.nastole.length-1), -1, false, true);
         
         var lizani = hra.povoleneLizani(karta);
         if (lizani > 0) pridejKartu(nastole, t('take_cards({1})', lizani), -1, lizani, true);
         
         $('div.klikaci').click(vezmiKartu);
         
         $('div#section_dalsibarva').addClass('hidden');
            
         var historie = $('div#historie');
         historie.empty();
         
         var zadna_historie = true;
         for(var hr_ix in hra.hraci) {
           if (hr_ix > 0) {
             if (hra.hraci[hr_ix].tah) {
               zadna_historie = false;
               historie.append('<div id="hrac-historie-'+hr_ix+'" class="hrac_historie"></div>');
               var hr_hist = $('div#hrac-historie-'+hr_ix);
               hr_hist.append('<div class="hrac_jmeno">' + hra.hraci[hr_ix].name + '</name>'); 
               pridejKartu(hr_hist, pocetKaretText(hra.hraci[hr_ix].vruce.length), -1, false, false);
               if (hra.hraci[hr_ix].tah.karta >= 0) {
                 if (hra.isColorCard(hra.hraci[hr_ix].tah.karta)) {
                   pridejKartu(hr_hist, hra.hraci[hr_ix].tah.karta, hra.hraci[hr_ix].tah.barva, false, false);
                 }
                 else {
                   pridejKartu(hr_hist, hra.hraci[hr_ix].tah.karta, -1, false, false);
                 };
               }
               else 
               if (hra.hraci[hr_ix].tah.lizal > 0) {
                 hr_hist.append('<div class="hrac_zprava">' + t('taken_cards:{1}', hra.hraci[hr_ix].tah.lizal) + '</div>');
               }
               else {
                 hr_hist.append('<div class="hrac_zprava">' + t('skipped_due_a') + '</div>');
               }
             };
           }
         };
         if (zadna_historie) {
           historie.append('<div id="hrac-historie-none" class="hrac_historie">' + t('no_moves_yet') + '</div>');
         };
         
         clearChoice();
         
         $('div#stolek').css('display', '');
      }
      function clickJdiNaTah() {
        displayStolek();
       };
      function displayVitez() {
        $('div#hrac_vitez').text(hra.actualPlayer().name);
        $('div#vitez').css('display', '');
      };
      function clickNovaHra () {
        $('div#vitez').css('display', 'none');
        initHraci();
      };
      function clickTahHotovy() {
        if (getChoice()=='' && !hra.cekani) {
          alert(t('decide_on_move_first'));
          return;
        };
        $('div#stolek').css('display', 'none');
        hra.dalsiTah(getChoice(), getColor());
        if (hra.endOfGame()) {
          displayVitez();
        }
        else {
          dalsiHrac();
          displayPredavka();
        };
      };
      function dalsiHrac() {
        hra.nextPlayer();
      };
    </script>
</head> 
<body> 
  <div id="header" class="header">
    <h1>
      <span id="h1_first" class="translate">game_header1</span>
      <span id="h1_second" class="translate">game_header2</span>
    </h1>
  </div>
  <div id="hraci" class="view">
    <div class="napoveda translate">player_intro</div>
    <div class="input_row">
      <div class="label"><label class="translate" for="name-hrace-1">player_1st</label></div>
      <div class="input"><input type="text" class="hraci_jmena" name="hrac-1" id="name-hrace-1"></div>
    </div>
    <div class="input_row">
      <div class="label"><label class="translate" for="name-hrace-2">player_2nd</label></div>
      <div class="input"><input type="text" class="hraci_jmena" name="hrac-2" id="name-hrace-2"></div>
    </div>
    <div class="hidden input_row">
      <div class="label"><label class="translate" for="name-hrace-3">player_3rd</label></div>
      <div class="input"><input type="text" class="hraci_jmena" name="hrac-3" id="name-hrace-3"></div>
    </div>
    <div class="hidden input_row">
      <div class="label"><label class="translate" for="name-hrace-4">player_4th</label></div>
      <div class="input"><input type="text" class="hraci_jmena" name="hrac-4" id="name-hrace-4"></div>
    </div>
    <div class="hidden input_row">
      <div class="label"><label class="translate" for="name-hrace-5">player_5th</label></div>
      <div class="input"><input type="text" class="hraci_jmena" name="hrac-5" id="name-hrace-5"></div>
    </div>
    <div id="zacni_hru" class="button translate">start_game_button</div>
    <div id="pridej_hrace" class="button translate">add_one_player</div>
  </div>
  <div id="stolek" class="view">
    <input type="hidden" id="stolek_volba" value=""/>
    <input type="hidden" id="stolek_barva" value=""/>
    <div class="section" id="section_hrac"></div>
    <div class="section" id="section_nastole">
      <div class="title translate">title_cards_on_desk</div>
      <div id="nastole"></div>
    </div>
    <div class="section hidden" id="section_dalsibarva">
      <div class="title translate">title_select_next_color</div>
      <div id="dalsibarva">
        <div data-barva="0" class="dalsibarva shadow"><img src="srdce68.png"></div>
        <div data-barva="1" class="dalsibarva shadow"><img src="kary68.png"></div>
        <div data-barva="2" class="dalsibarva shadow"><img src="zelena68.png"></div>
        <div data-barva="3" class="dalsibarva shadow"><img src="zaludy68.png"></div>
      </div>
    </div>
    <div class="section" id="section_vruce">
      <div class="title translate">title_cards_in_hand</div>
      <div id="vruce"></div>
    </div>
    <div class="button translate" id="tah_hotovy">ready_next_button</div>
    <div class="section" id="section_historie">
      <div class="title translate">title_other_players</div>
      <div id="historie"></div>
    </div>
  </div>
  <div id="predavka" class="view">
    <div class="panel">
      <span class="translate">next_player_is</span>
      <div id="hrac_predavka"></div>
      <span class="translate">when_ready_click_button</span>
      <div class="button translate" id="jdi_na_tah">ready_for_game_button</div>
    </div>
  </div>
  <div id="vitez" class="view">
    <div class="panel">
      <span id="title_vitez" class="translate">and_winner_is</span>
      <div id="hrac_vitez"></div>
      <span class="translate">celebrate_hint</span>
      <div class="button translate" id="nova_hra">new_game_button</div>
    </div>
  </div>
</body>
</html>