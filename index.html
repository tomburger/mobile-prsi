<!DOCTYPE html> 
<html> 
    <head> 
    <title>Karetni hra Prsi</title> 
    <script type="text/javascript" charset="utf-8" src="phonegap.js"></script>
    <script type="text/javascript" charset="utf-8" src="jquery.js"></script>
    <style>
      body { height: 100%; background-color: #dfdfff; margin: 0px; padding: 0px; }
      div.header { padding: 5px; text-align: left; background-color: black; }
      div.header h1 { margin: 0px; color: white; font: bold 1em Arial, sans-serif; }
      div.view { margin: 0px; padding: 5px 0px; }
      div.input_row { 
          clear: both; height: 35px;
          margin: 0px 0px 5px 0px; }
      div.input { padding: 0px; float: left; }
      input.hraci_jmena { 
          padding: 5px; margin: 3px;
          border: 1px solid orange; border-radius: 5px;}
      div.label { 
          padding: 10px 5px;
          font: 14px Arial, sans-serif;
          float: left; width: 100px;
          text-align: right;
      }
      div.hidden { display: none; }
      div.button {
          clear: both;
          padding: 5px;
          margin: 0px 5px;
          border: 1px solid black;
          border-radius: 5px;
          background-color: #4f4f4f;
          font: 20px Arial, sans-serif;
          text-align: center;
          text-shadow: 1px 1px 2px black;
          cursor: pointer;
          color: white;
          font-weight: bold;
      }
      div.disabled {
          color: gray;
      }
      div.panel {
      	  margin: 10px; padding: 10px; 
      	  font: bold 15px Arial, sans-serif; 
      	  text-align: center;
      }
      div#predavka div.panel {
      	  background-color: black; color: white;
      }
      div#hrac_jmeno {
      	  border: 1px solid white;
      	  border-radius: 10px;
      	  font: bold 40px Arial, sans-serif; color: white;
      	  margin: 30px 10px 30px 10px; padding: 10px; 
      }
      div#vitez div.panel {
      	  background-color: #7fff7f; color: #7f2f2f;
      }
      div#hrac_vitez {
      	  border: 1px solid white;
      	  font: bold 40px Arial, sans-serif; color: white;
      	  margin: 30px 10px 30px 10px; padding: 10px; 
      }
      div.panel div.button {
      	  margin-top: 40px;
      }
      div.title {
      }
      div.karta_box {
      	  float: left;
      	  width: 70px; 
      	  margin: 2px; 
      	  border: #dfdfff 1px solid;
      }
      div.klikaci {
      	  cursor: pointer;
      }
      div.maznuta {
        opacity: .3;
      }
      div.vyrazna {
        border: white 1px solid;
      }
      div.karta {
      	  width: 68px; height: 68px; 
      	  border: black solid 1px;
      	  border-radius: 2px;
      	  margin-bottom: 3px;
      	  font: bold 50px Arial, sans-serif;
      	  text-align: center;
      	  vertical-align: middle; 
      }
      div.srdce  {
        color: black;
        text-shadow: 1px 1px 2px white;
        background: url('srdce.png') no-repeat; 
      }
      div.kary   { 
        color: black;
        text-shadow: 1px 1px 2px white;
        background: url('kary.png') no-repeat; 
      }
      div.zelena {
        color: #c0905f;
        text-shadow: 1px 1px 2px white;
        background: url('zelena.png') no-repeat; 
      }
      div.zaludy { 
        color: #c0905f;
        text-shadow: 1px 1px 2px white;
        background: url('zaludy.png') no-repeat; 
      }
      div.rub-karta {
      	  width: 68px; height: 68px; 
      	  border: black solid 1px;
      	  margin-bottom: 3px; 
      	  background-color: silver; color: black;
      	  font: bold 25px Arial, sans-serif;
      	  text-align: center;
      	  vertical-align: middle; 
      }
      div.podstavec {
          width: 70px; height: 7px;
          margin: 0px; padding: 0px;
          font-size: 1px;
      }
      div.podkartou {
          width: 68px;
          background-color: #7fff59; color: #7fff59;
          border: 1px solid white;
          height: 5px; border-radius: 2px;
          font-size: 1px;
      }
      div.title {
        clear:both;
     	  margin: 0px; padding: 5px; background-color: blue;
      	font: bold 12px Arial, sans-serif; color: white;
      	text-align: center;
      }
      div#section_hrac {
        margin: 5px; 
        background-color: #c0d0c0;
      	font: bold 20px Arial, sans-serif; color: black;
      	padding: 5px;
      }
      div.dalsibarva {
          float: left;
      	  width: 70px; height: 68px;
      	  text-align: center;
      	  margin: 2px;
      	  border: #dfdfff 1px solid;
      }
      div.dalsibarva img {
      	  border: black solid 1px;
      	  border-radius: 2px;
      	  margin-bottom: 3px;
      }
      div.hrac_historie {
        clear: both; margin: 5px;
        height: 80px;
        background-color: #c0d0c0;
      }
      div.hrac_jmeno {
      	font: bold 20px Arial, sans-serif; color: black;
      	padding: 5px; 
        float: left; width: 120px;
      }
      div.hrac_zprava {
      	font: bold 20px Arial, sans-serif; color: black;
      	padding: 5px; 
        float: left;
      }
    </style>
    <script type="text/javascript">
      $(document).ready(function() {
          $('div#zacni_hru').click(clickZacniHru);
          $('div#jdi_na_tah').click(clickJdiNaTah);
          $('div#tah_hotovy').click(clickTahHotovy);
          $('div#nova_hra').click(clickNovaHra);
          $('div.dalsibarva').click(clickDalsiBarva);
          $('input.hraci_jmena').change(changeHraciJmena);
          $('div.view').css('display', 'none');
          $('div.panel').height(300);
          initHraci();
      });
      var enabledZacniHru = false;
      function initHraci() {
          $('div#hraci').css('display', '');
          changeHraciJmena(null);
      };
      function changeHraciJmena(event) {
      	  var vyplneniHraci = $('input.hraci_jmena').filter(
      	  	  function(index) { return this.value; }
      	  	  );
      	  enabledZacniHru = (vyplneniHraci.length >= 2);
      	  if (enabledZacniHru) 
            $('div#zacni_hru').removeClass('disabled')
          else
            $('div#zacni_hru').addClass('disabled');
      };
      var hra = {};
      var hodnoty = ['7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
      var barvy = ['srdce', 'kary', 'zelena', 'zaludy'];
      function clickZacniHru(event) {
          if (!enabledZacniHru) {
            alert('Jsou potreba aspon dva hraci');
          }
          else {
              $('div#hraci').css('display', 'none');
              pripravHru();
              displayPredavka();
          };
      };
      function displayPredavka() {
          $('div#hrac_jmeno').text(hra.hraci[hra.aktualni].name);
          $('div#predavka').css('display', '');
      };
      function pripravHru() {
        hra = { hraci: [], karty: [], nastole: [], lizani: 0, cekani: false, historie: [] };
      	 var hr_index = 0;
         $('input.hraci_jmena').map(function(index, el) {
         		 if (el.value) {
          		 	 hra.hraci[hr_index++] = { 
          		 	   name: el.value, 
          		 	   vruce: [] 
          		 	 };
         		 };
         });
         var kr_index = 0;
         var karty = [];
         for(var hd_ix in hodnoty) {
           for(var br_ix in barvy) {
             karty[kr_index++] = { 
               id: barvy[br_ix]+'-'+hodnoty[hd_ix],
               barva: br_ix, hodnota: hd_ix
             };
           }
         };
         // zamichat karty
         while (karty.length > 0) {
           var rnd_ix = Math.floor(Math.random()*karty.length)
           hra.karty.push(karty.splice(rnd_ix, 1)[0]);
         };
         kr_trideni = 0;
         for(var ix in [1,2,3,4]) {
           for(var hr_ix in hra.hraci) {
             var hrac = hra.hraci[hr_ix];
             hrac.vruce.push(kr_trideni++);
           }
         };
         while(kr_trideni<hra.karty.length) {
           hra.nastole.push(kr_trideni++);
         };
         hra.dalsi_barva = hra.karty[hra.nastole[0]].barva;
         hra.aktualni = 0;
         hra.lizani = (hodnoty[hra.karty[hra.nastole[0]].hodnota] == '7') ? 2 : 0;
         hra.cekani = (hodnoty[hra.karty[hra.nastole[0]].hodnota] == 'A');
      };
      function pridejKartu(el, kr_ix, btn) {
        if (typeof(kr_ix) == 'number') {
          var karta = hra.karty[kr_ix];
          var barva = barvy[karta.barva] 
          var kr_html = '<div class="karta '
                      + barva + '">'
                      + hodnoty[karta.hodnota]
                      + '</div>';
          var dt_karta = kr_ix; 
        }
        else {
          var kr_html = '<div class="rub-karta">'+kr_ix+'</div>';
          var dt_karta = -btn;
        }
        var html = '<div data-karta="'+dt_karta+'" class="karta_box'
                 + (btn > 0 ? ' klikaci': '') + '">';
        html += kr_html;
        html += (btn > 0)
              ? '<div id="button-podkartou-'+kr_ix+'" class="podkartou">.</div>'
              : '<div class="podstavec">.</div>';
        html += '</div>';
        el.append(html);
      }
      function vezmiKartu() {
        if ($(this).hasClass('vyrazna')) {
          $('div.karta_box')
            .removeClass('vyrazna')
            .removeClass('maznuta');
          hra.volba = null;
          if (!hra.cekani) $('div#tah_hotovy').addClass('disabled');
          $('div#section_dalsibarva').addClass('hidden');
        }
        else {
          $('div.karta_box')
            .removeClass('vyrazna')
            .addClass('maznuta');
          $(this)
            .removeClass('maznuta')
            .addClass('vyrazna');
          hra.volba = parseInt(this.attributes['data-karta'].value);
          if (hra.volba >= 0 && hodnoty[hra.karty[hra.volba].hodnota] == 'Q') { 
            $('div#tah_hotovy').addClass('disabled');
            $('div.dalsibarva').removeClass('maznuta');
            $('div#section_dalsibarva').removeClass('hidden');
          }
          else {
            $('div#tah_hotovy').removeClass('disabled');
            $('div#section_dalsibarva').addClass('hidden');
          }
        };
      };
      function clickDalsiBarva() {
        $('div.dalsibarva').addClass('maznuta');
        $(this).removeClass('maznuta');
        hra.dalsi_barva = parseInt(this.attributes['data-barva'].value);
        $('div#tah_hotovy').removeClass('disabled');
      }
      function povolenaKarta(karta) {
        var karta_barva = hra.karty[karta].barva;
        var nastole_barva = hra.dalsi_barva;
        var karta_hodnota = hra.karty[karta].hodnota;
        var nastole_hodnota = hra.karty[hra.nastole[0]].hodnota;
             
        var povoleno = false;
        if (hra.lizani > 0 && hodnoty[nastole_hodnota] == '7') {
          povoleno = (karta_hodnota == nastole_hodnota)
        }
        else 
        if (hra.cekani && hodnoty[nastole_hodnota] == 'A') {
          povoleno = (karta_hodnota == nastole_hodnota)
        }
        else {
          povoleno = ( 
                       hodnoty[karta_hodnota] == 'Q'     // svrsek muze vzdycky 
                   ||  karta_barva == nastole_barva || karta_hodnota == nastole_hodnota
          );
        };
        return (povoleno? 1 : 0);
      }
      function povoleneLizani(karta) {
        var nastole_hodnota = hra.karty[hra.nastole[0]].hodnota;
             
        var povoleno = 1;
        if (hra.lizani > 0 && hodnoty[nastole_hodnota] == '7') {
          povoleno = hra.lizani;
        }
        else if (hra.cekani && hodnoty[nastole_hodnota] == 'A') {
          povoleno = 0;
        };
        return povoleno;
      }
      function displayStolek() {
         $('div#predavka').css('display', 'none');
         
         $('div#section_hrac').text('Na tahu je hrac ' + hra.hraci[hra.aktualni].name + '.');
         
         var vruce = $('div#vruce');
         vruce.empty();
         for(var kr_ix in hra.hraci[hra.aktualni].vruce) {
           var karta = hra.hraci[hra.aktualni].vruce[kr_ix];
           pridejKartu(vruce, karta, povolenaKarta(karta));
         };
         
         var nastole = $('div#nastole');
         nastole.empty();
         pridejKartu(nastole, hra.nastole[0], false);
         pridejKartu(nastole, hra.nastole.length-1 + ' karet', false);
         
         var lizani = povoleneLizani(karta);
         if (lizani > 0) pridejKartu(nastole, 'Lizni ' + lizani, lizani);
         
         $('div.klikaci').click(vezmiKartu);
         
         $('div#section_dalsibarva').addClass('hidden');
            
         var historie = $('div#historie');
         historie.empty();
         for(var hr_ix in hra.hraci) {
           if (hr_ix != hra.aktualni) {
             historie.append('<div id="hrac-historie-'+hr_ix+'" class="hrac_historie"></div>');
             var hr_hist = $('div#hrac-historie-'+hr_ix);
             hr_hist.append('<div class="hrac_jmeno">' + hra.hraci[hr_ix].name + '</name>'); 
             pridejKartu(hr_hist, 
               hra.hraci[hr_ix].vruce.length + ' karet', false);
             if (hra.hraci[hr_ix].tah) {
               if (hra.hraci[hr_ix].tah.karta >= 0) {
                 pridejKartu(hr_hist, hra.hraci[hr_ix].tah.karta, false);
                 if (hodnoty[hra.karty[hra.hraci[hr_ix].tah.karta].hodnota]=='Q') {
                   hr_hist.append('<div class="hrac_zprava">Nova barva je<br/>' + barvy[hra.hraci[hr_ix].tah.barva] + '</div>');
                 }
               }
               else 
               if (hra.hraci[hr_ix].tah.lizal > 0) {
                 hr_hist.append('<div class="hrac_zprava">' + hra.hraci[hr_ix].tah.lizal + 'krat<br/>liznul</div>');
               }
               else {
                 hr_hist.append('<div class="hrac_zprava">Vynechal</div>');
               }
             }
             else {
               hr_hist.append('<div class="hrac_zprava">Jeste<br/>nehral</div>');
             }
           }
         };
         
         hra.volba = null;
         if (!hra.cekani) $('div#tah_hotovy').addClass('disabled');
         
         $('div#stolek').css('display', '');
      }
      function zapisHistorii(lizal, karta, barva) {
        hra.hraci[hra.aktualni].tah = {'lizal': lizal, 'karta': karta, 'barva': barva};
        hra.historie.unshift({'hrac': hra.aktualni, 'lizal': lizal, 'karta': karta, 'barva': barva});
      }
      function dalsiTah() {
        if (hra.volba==null) {
          zapisHistorii(0, -1, -1);
        }
        else {
          if (hra.volba < 0) { // liznout ze stolu
            var karty = -hra.volba;
            zapisHistorii(karty, -1, -1);
            while (karty > 0) {
              hra.hraci[hra.aktualni].vruce.push(hra.nastole.pop());
              karty--;
            };
            hra.lizani = 0;
          }
          else {               // vyhodit zvolenou kartu
            var idx = hra.hraci[hra.aktualni].vruce.indexOf(hra.volba);
            if (idx != -1) { 
              hra.hraci[hra.aktualni].vruce.splice(idx, 1);
              hra.nastole.unshift(hra.volba);
              if (hodnoty[hra.karty[hra.volba].hodnota]=='7') {
                hra.lizani += 2;
              };
              if (hodnoty[hra.karty[hra.volba].hodnota]=='A') {
                hra.cekani = true;
              };
              if (hodnoty[hra.karty[hra.volba].hodnota]=='Q') {
                // svrsek urcil barvu uz driv...
              }
              else {
                hra.dalsi_barva = hra.karty[hra.nastole[0]].barva;
              };
              zapisHistorii(0, hra.volba, hra.dalsi_barva);
            };
          };
        };
      }
      function clickJdiNaTah() {
        displayStolek();
       };
      function displayVitez() {
        $('div#hrac_vitez').text(hra.hraci[hra.aktualni].name);
        $('div#vitez').css('display', '');
      };
      function clickNovaHra () {
        $('div#vitez').css('display', 'none');
        initHraci();
      };
      function clickTahHotovy() {
        if (hra.volba==null) {
          if (hra.cekani) {
            hra.cekani = false; // cekame na esu, nedelame nic...
          }
          else {
            alert('Jeste si se nerozhodl, jaky bude dalsi tah!');
            return;
          };
        };
        $('div#stolek').css('display', 'none');
        dalsiTah();
        if (hra.hraci[hra.aktualni].vruce.length==0) {
          displayVitez();
        }
        else {
          dalsiHrac();
          displayPredavka();
        };
      };
      function dalsiHrac() {
      	 hra.aktualni++;
      	 if (!hra.hraci[hra.aktualni]) hra.aktualni = 0;
      };
    </script>
</head> 
<body> 
  <div id="header" class="header">
    <h1>Prsi - karetni hra</h1>
  </div>
  <div id="hraci" class="view">
    <div class="input_row">
      <div class="label"><label for="name-hrace-1">Prvni hrac</label></div>
      <div class="input"><input type="text" class="hraci_jmena" name="hrac-1" id="name-hrace-1"></div>
    </div>
    <div class="input_row">
      <div class="label"><label for="name-hrace-2">Druhy hrac</label></div>
      <div class="input"><input type="text" class="hraci_jmena" name="hrac-2" id="name-hrace-2"></div>
    </div>
    <div class="input_row">
      <div class="label"><label for="name-hrace-3">Treti hrac</label></div>
      <div class="input"><input type="text" class="hraci_jmena" name="hrac-3" id="name-hrace-3"></div>
    </div>
    <div class="input_row">
      <div class="label"><label for="name-hrace-4">Ctvrty hrac</label></div>
      <div class="input"><input type="text" class="hraci_jmena" name="hrac-4" id="name-hrace-4"></div>
    </div>
    <div class="input_row">
      <div class="label"><label for="name-hrace-5">Paty hrac</label></div>
      <div class="input"><input type="text" class="hraci_jmena" name="hrac-5" id="name-hrace-5"></div>
    </div>
    <div id="zacni_hru" class="button">Zacni hru</div>
  </div>
  <div id="stolek" class="view">
    <div id="section_hrac"></div>
    <div id="section_nastole">
      <div class="title">Karty na stole</div>
      <div id="nastole"></div>
    </div>
    <div class="hidden" id="section_dalsibarva">
      <div class="title">Zvol dalsi barvu</div>
      <div id="dalsibarva">
        <div data-barva="0" class="dalsibarva"><img src="srdce.png"></div>
        <div data-barva="1" class="dalsibarva"><img src="kary.png"></div>
        <div data-barva="2" class="dalsibarva"><img src="zelena.png"></div>
        <div data-barva="3" class="dalsibarva"><img src="zaludy.png"></div>
      </div>
    </div>
    <div id="section_vruce">
      <div class="title">Karty co mas v ruce</div>
      <div id="vruce"></div>
    </div>
    <div id="section_historie">
      <div class="title">Ostatni hraci</div>
      <div id="historie"></div>
    </div>
    <div class="button" id="tah_hotovy">Hotovo! Dalsi hrac</div>
  </div>
  <div id="predavka" class="view">
    <div class="panel">
      Na rade je
      <div id="hrac_jmeno"></div>
      Az budes pripraveny, klikni na tlacitko...
      <div class="button" id="jdi_na_tah">Pripraven na hru</div>
    </div>
  </div>
  <div id="vitez" class="view">
    <div class="panel">
      Tradaaaa! Vitezem se stava
      <div id="hrac_vitez"></div>
      Trosku to oslavte a pustte se do odvety
      <div class="button" id="nova_hra">Nova hra</div>
    </div>
  </div>
</body>
</html>